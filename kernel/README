#################
## COMPILATION ##
#################

## Notice: This is a partial -work in progress- procedure.
##         Some steps are (mostly volontary) not complete.

# Define some config environment variables
export KERN=3.18
export KERNSUB=21
export RT=19

# Download kernel
wget -c https://www.kernel.org/pub/linux/kernel/v3.x/linux-${KERN}.${KERNSUB}.tar.xz

# Download linux-rt patch
wget -c https://www.kernel.org/pub/linux/kernel/projects/rt/${KERN}/older/patch-${KERN}.${KERNSUB}-rt${RT}.patch.xz

# Untar kernel
tar -xJf linux-${KERN}.${KERNSUB}.tar.xz

# Patch kernel
xz -cd patch-${KERN}.${KERNSUB}-rt${RT}.patch.xz | patch -d linux-${KERN}.${KERNSUB} -p1

# Copy Sikula defconfig
cp sikula_bbb_rt_defconfig linux-${KERN}.${KERNSUB}/arch/arm/configs/

# Copy Sikula DTS for BBB+IO2
cp sikula_bbb_io2.dts linux-${KERN}.${KERNSUB}/arch/arm/boot/dts/

# Patching DTS Makefile
patch -d linux-${KERN}.${KERNSUB} -p1 < sikula_bbb_io2-dts-makefile.patch

# Go to kernel directory
cd linux-${KERN}.${KERNSUB}

# Applying defconfig
make ARCH=arm sikula_bbb_rt_defconfig

# Compile kernel, modules and dtbs
make ARCH=arm CROSS_COMPILE=archlinuxarm- zImage modules dtbs -j16


##################
## INSTALLATION ##
##################

## Notice: Environment variable $TARGET is supposed to be set with path to
##         target rootfs (mounted partition of SD).
[ "$TARGET" == "" ] && echo "Error, TARGET is not defined"
[ "$TARGET" == "" ] && exit 1

# Copy kernel
cp arch/arm/boot/zImage ${TARGET}/boot/zImage-sikula-rt

# Copy DTB
cp arch/arm/boot/dts/sikula_bbb_io2.dtb ${TARGET}/boot/dtbs/

# Install modules
make ARCH=arm INSTALL_MOD_PATH=${TARGET}/ modules_install

# Copy uEnv.txt (replace original)
cp uEnv.txt ${TARGET}/boot/uEnv.txt
