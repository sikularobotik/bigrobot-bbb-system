#################
## COMPILATION ##
#################

## Notice: This is a partial -work in progress- procedure.
##         Some steps are (mostly volontary) not complete.

# Define some config environment variables
KERN=3.14
KERNSUB=34
RT=31

# Download kernel
wget https://www.kernel.org/pub/linux/kernel/v3.x/linux-${KERN}.${KERNSUB}.tar.xz

# Download linux-rt patch
wget https://www.kernel.org/pub/linux/kernel/projects/rt/${KERN}/patch-${KERN}.${KERNSUB}-rt${RT}.patch.xz

# Untar kernel
tar -xJf linux-${KERN}.${KERNSUB}.tar.xz

# Patch kernel
xz -cd patch-${KERN}.${KERNSUB}-rt${RT}.patch.xz | patch -d linux-${KERN}.${KERNSUB} -p1

# Copy Sikula defconfig
cp sikula_bbb_rt_defconfig linux-${KERN}.${KERNSUB}/arch/arm/configs/

# Copy Sikula DTS for BBB+IO2
cp sikula_bbb_io2.dts linux-${KERN}.${KERNSUB}/arch/arm/boot/dts/

# Go to kernel directory
cd linux-${KERN}.${KERNSUB}

# Applying defconfig
make ARCH=arm sikula_bbb_rt_defconfig

# Patching DTS Makefile
patch -p1 < ../sikula_bbb_io2-dts-makefile.patch

# Compile kernel, modules and dtbs
make ARCH=arm CROSS_COMPILE=archlinuxarm- zImage modules dtbs -j16


##################
## INSTALLATION ##
##################

## Notice: Environment variable $TARGET is supposed to be set with path to
##         target rootfs (2nd partition on SD) while $BOOT is the path to
##         target boot partition (1st partition on SD)

# Copy kernel
cp arch/arm/boot/zImage ${TARGET}/boot/zImage-sikula-rt

# Copy DTB
cp arch/arm/boot/dts/sikula_bbb_io2.dtb ${TARGET}/boot/dtbs/

# Install modules
make ARCH=arm INSTALL_MOD_PATH=${TARGET}/ modules_install

# Copy uEnv.txt (replace original)
cp uEnv.txt ${BOOT}/uEnv.txt
